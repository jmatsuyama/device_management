# データフロー設計

## 1. デバイス管理フロー

### 1.1 デバイス登録フロー
```
[ユーザー(JEIS)] → デバイス情報入力
    → [アプリケーション] デバイス情報バリデーション
        → [データベース] Deviceテーブルに保存
            → [ユーザー] 登録完了通知
```

### 1.2 デバイスCSV管理フロー
```
[エクスポート]
[JEIS担当者] → マスター管理画面
    → エクスポート要求
        → [アプリケーション] デバイス情報取得
            → [データベース] SELECT実行
                → [アプリケーション] CSV生成（BOM付きUTF-8）
                    → [JEIS担当者] CSVダウンロード

[インポート]
[JEIS担当者] → マスター管理画面
    → CSVアップロード
        → [アプリケーション] CSVパース・バリデーション
            → [データベース] 一括更新/登録
                → [JEIS担当者] 処理結果通知
```

## 2. ロッカー管理フロー

### 2.1 パスワード発行フロー
```
[JEIS担当者] → パスワード発行要求
    → [アプリケーション] パスワード生成
        → [データベース] ロッカー情報更新
            → [JEIS担当者] パスワード表示
                → [JR担当者] パスワード受け取り
```

### 2.2 ロッカー認証フロー
```
[JR担当者] → パスワード入力
    → [アプリケーション] パスワード検証
        → [データベース] ロッカー状態更新
            → [JR担当者] 解錠完了通知
```

## 3. ユーザー管理フロー

### 3.1 ユーザー認証フロー
```
[ユーザー] → ログイン情報入力
    → [アプリケーション] 認証処理
        → [データベース] ユーザー情報照会
            → [アプリケーション] セッション作成
                → [ユーザー] リダイレクト
```

### 3.2 ユーザー登録フロー
```
[管理者] → ユーザー情報入力
    → [アプリケーション] バリデーション
        → [データベース] ユーザー情報保存
            → [管理者] 登録完了通知
```

## 4. データ処理フロー

### 4.1 デバイスステータス更新
```
[入力] デバイス情報
    → [バリデーション] 必須項目・形式チェック
        → [データ加工] 日付形式変換
            → [保存] データベース更新
                → [通知] 処理結果表示
```

### 4.2 ロッカー状態管理
```
[入力] ロッカー操作
    → [状態チェック] 現在の状態確認
        → [更新] 状態変更処理
            → [記録] 操作ログ保存
                → [通知] 状態変更完了
```

## 5. エラーハンドリングフロー

### 5.1 データ検証エラー
```
[入力] ユーザー入力
    → [検証] バリデーション
        → [エラー検出] エラー内容特定
            → [メッセージ生成] エラーメッセージ作成
                → [表示] ユーザーへのフィードバック
```

### 5.2 システムエラー
```
[発生] エラー検出
    → [ログ記録] エラー情報保存
        → [メッセージ変換] ユーザー向けメッセージ作成
            → [表示] エラー画面表示
```

## 6. バッチ処理フロー

### 6.1 パスワード有効期限管理
```
[定期実行] 期限チェック処理
    → [検索] 期限切れパスワード抽出
        → [更新] パスワードクリア
            → [記録] 処理ログ保存
```

### 6.2 デバイス状態監視
```
[定期実行] 状態チェック処理
    → [検索] 期限切れデバイス抽出
        → [更新] ステータス更新
            → [通知] 管理者への通知
```